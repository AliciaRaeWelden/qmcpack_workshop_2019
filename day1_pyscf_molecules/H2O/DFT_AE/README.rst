Example 1: H2O All Electron with a DFT nodal surface
====================

In this example we will go through the basic steps necessary to
generate DMC input from a pyscf calculation on a simple closed
shell molecule H2O in all electrons and the cc-pvtz basis set.

The pyscf scf script is given below (h2o_ae_dft.py in the current directory):

.. code-block:: python

    from pyscf import gto
    from pyscf import scf, dft, df


    mol = gto.Mole()
    mol.verbose = 5
    mol.atom =''' 
      H             0.00000000       0.75720000      -0.46920000
      H             0.00000000      -0.75720000      -0.46920000
      O             0.00000000       0.00000000       0.11730000
    '''
    mol.unit='A'
    mol.basis = 'cc-pvtz'
    #mol.pseudo = 'bfd-vtz'
    mol.spin=0 #Value of S where the spin multiplicity is 2S+1
    mol.build()



    #Hartree Fock
    #mf = scf.ROHF(mol)

    #DFT
    mf = dft.ROKS(mol)
    mf.xc ='b3lyp' 

    e_scf=mf.kernel()

    #Section for QMCPACK
    title="H2O_AE_DFT"
    from PyscfToQmcpack import savetoqmcpack
    savetoqmcpack(mol,mf,title=title)


It is important to note that Pyscf recognizes most of the XC functionals and basis sets. 
For a complete list of refer to Pyscf Manual in https://sunqm.github.io/pyscf/dft.html#

In order to generate the HDF5 necessary to run QMCPACK we call the function "savetoqmcpack" 
located in "qmcpack/src/QMCTools/PyscfToQmcpack.py".  
This will generate an HDF5 file named "$title.h5" (in this case H2O_AE_DFT.h5) containing all 
information necessary to run QMCPACK. 
For this call to work, It is important to have "qmcpack/src/QMCTools/" in your PYTHONPATH.

We next run the pyscf calculation using

.. code-block:: bash

    python h2o_ae_dft.py > h2o_ae_dft.out 

which will yield a converged restricted orbitals DFT total energy of -76.4227090252327 Ha 


The next step is to generate the necessary qmcpack input from this scf calculation. 

.. code-block:: bash

    mpirun -n 1 convert4qmc -pyscf H2O_AE_DFT.h5 -production -addCusp

This operation will generate 3 files: 
  1- H2O_AE_DFT.structure.xml (present in the directory)
	This file contains the system geometry, the number of atoms and the number of electrons.
 
  2- H2O_AE_DFT.wfj.xml (present in the directory)
	This file contains the trial wavefunction. The basis set, MO coefficients and all non mutable 
        data are stored in the HDF5 file referenced in the trial wavefunction. Only Jastrow data and 
        important information is kept in the HDF5. This allows a lighter IO and more user friendly inputs.

  3- H2O_AE_DFT.qmc.in.xml (present in the directory)
        This file contains what is considered a "standard production" QMC block, from the Jastrow Optimmization 
        blocks, to VMC and DMC blocks. 
        IMPORTANT NOTE: THIS BLOCKS ARE NOT TAILORED FOR THE PROBLEM, MACHINE OR ACCURACY YOU MAY WANT TO REACH
                        THEY ARE TO BE USED AS GUIDE LINES TO BE MODIFIED AS SEEN IN THE FOLLOWING SECTIONS.


In this example, convert4qmc takes 4 arguments;
   1- -pyscf: The code name generating the HDF5. Other options are -QP (quantum package) or -gamess. Note that 
      the option -orbitals is also available and reads natively hdf5 files generated by QP and Pyscf. 
   2- $title.h5: the name of the HDF5 file. 
   3- -production : This flag will force to generate a set of "GUESS" Optimization blocks and VMC and DMC blocks
      for production. Please Note that these blocks are mainly suggestions and should be adapted to the system,
      machine and desired accuracies.
   4- -addCusp:  Since we are running an all electron calculation, we need a scheme to forbid electrons to move 
       too close to the nuclei. Adding this tag will modify the orbitals and will add a cusp correction to the orbitals.
       in the Trial Wave function file the Cusp Correction scheme is triggered by the following lines:    
       
.. code-block:: xml
    <determinantset type="MolecularOrbital" name="LCAOBSet" source="ion0" transform="yes" cuspCorrection="yes" href="../H2O_AE_DFT.h5">
The tag CuspCorrection=yes will call the CuspCorrection. 

The Cusp Correction will be done for the orbotals in spin up and orbitals in spin down. While this operation is relatively fast for 
small molecules, specially when only occupied orbitals are to be considered, it might be necessary store the correction parameters. 
If already stored, the parameters (updet.cuspInfo.xml and downdet.cuspInfo.xml) can be speicified as follow in the wfj.xml file:

.. code-block:: xml
        <determinant id="updet" size="5" cuspInfo="../CuspCorrection/updet.cuspInfo.xml">


Running QMC:
Step 1- CuspCorrection AND a VMC block with No Jastrow to compare our result to DFT (files in ref_files/CuspCorrection.
   
.. code-block:: bash 
      cd CuspCorrection
      mpirun -n 1 qmcpack Cusp.xml | tee Cusp.out

NOTE: Compare carefully the Cusp.xml and H2O_AE_DFT.wfj.xml files (provided in the directory) and the H2O_AE_DFT.qmc.in.xml and 
H2O_AE_DFT.wfj.xml  generated by convert4qmc. You will notice the lack of Jastrow functions (to capture only the Antysymmetric 
part of the trial wavefunction and a longer than necessary VMC block to compare to the DFT Energy.  


.. code-block:: bash 
     qmca -q ev *.scalar.dat
                            LocalEnergy               Variance           ratio 
     H2O_AE_DFT  series 0  -76.061535 +/- 0.008421   17.644684 +/- 0.510746   0.2320 

This  energy is significantly different from the DFT result of -76.4227090252327 Ha. 
The reason is DFT adds to the energy an XC energy from the used functional. VMC does not.

Step 2- Jastrow Optimization:
In the Optimization directory, we modify slightly the Jastrow to have 20 parameters for the 2 body Jastrow with a cutoff of 10 Angstrom 
and 10 parameters and a cutoff of 5 Angstrom for the one body Jastrow. 

Since the starting parameters for the optimization are significantly bad (0 0 0 0 0 ...) we use 2 loops with different values, 
from "aggressive" to more restrictive.  Note the difference between the used number of samples (8000->80000)  and the value of 
minwalker (0.0001->0.1) between in the input file

.. code-block:: xml
  <loop max="4">
    <qmc method="linear" move="pbyp" checkpoint="-1">
      <parameter name="samples">80000</parameter>
      <parameter name="minwalkers">0.1</parameter>
    </qmc>
  </loop>

The Jastrow Optimization should always be made in 2 steps. First optimizing 1 and 2 body Jastrow (No 3 Bodies), Then in a second 
step adding 3 body Jastrows. This will avoid having to optimize too many parameters in one run and introducing too much instability

In the Optimization directory you will find an Opt.xml file containing the optimization blocks (whill start enumerating outputs 
from 0 to 14). The enumeration is controlled with the tag:

.. code-block:: xml
 
  <project id="H2O_AE_DFT" series="0"/>

The outcome of the optimization should generate 15 files named H2O_AE_DFT.sXXX.scalar.dat where XXX=000..014
IMPORTANT: The optimized Jastrow Parameters will be in the H2O_AE_DFT.sXXX.opt.xml files. These files can replace a wfj.xml Wavefunction
To select the est JAstrow Parameters they need to lead to the lowest VMC energy: 

.. code-block:: bash 
     mpirun -n 1 qmcpack Opt.xml | tee Opt.out
     qmca -q ev *.scalar.dat | sort -k4

                            LocalEnergy               Variance           ratio 
     H2O_AE_DFT  series 0  -75.374060 +/- 0.371321   6.717349 +/- 2.587564   0.0891 
     H2O_AE_DFT  series 1  -76.128852 +/- 0.038761   5.963490 +/- 0.174963   0.0783 
     H2O_AE_DFT  series 10  -76.314322 +/- 0.013607   4.405358 +/- 0.182043   0.0577 
     H2O_AE_DFT  series 6  -76.321053 +/- 0.021226   4.649470 +/- 0.261492   0.0609 
     H2O_AE_DFT  series 5  -76.321748 +/- 0.011121   4.256483 +/- 0.126845   0.0558 
     H2O_AE_DFT  series 13  -76.328038 +/- 0.013470   4.260497 +/- 0.079198   0.0558 
     H2O_AE_DFT  series 9  -76.328197 +/- 0.013156   4.191349 +/- 0.101476   0.0549 
     H2O_AE_DFT  series 14  -76.329850 +/- 0.012077   4.531482 +/- 0.228191   0.0594 
     H2O_AE_DFT  series 2  -76.336262 +/- 0.027683   3.460298 +/- 0.111215   0.0453 
     H2O_AE_DFT  series 4  -76.342807 +/- 0.019891   4.292159 +/- 0.129885   0.0562 
     H2O_AE_DFT  series 3  -76.344315 +/- 0.017467   4.026520 +/- 0.168988   0.0527 
     H2O_AE_DFT  series 8  -76.345056 +/- 0.014600   4.080318 +/- 0.060097   0.0534 
     H2O_AE_DFT  series 7  -76.346992 +/- 0.011128   4.299614 +/- 0.080107   0.0563 
     H2O_AE_DFT  series 11  -76.349011 +/- 0.012945   4.487658 +/- 0.088711   0.0588 
     H2O_AE_DFT  series 12  -76.368072 +/- 0.014845   4.313579 +/- 0.090184   0.0565 

In this case Series 12 while being the lowest in energy yields a higher variance and a larger error bar and it would be better to
discard it as an outlayer.

Series 11 seems to be better. In the case, the energy in the series 11 was computed using the Jastrow from the previous round. 
Explanation: At the end of an optimization block N, we generate a series of Jastrow parameters. These will be used to evaluate a VMC energy at Loop N+1.
Therefore if the Energy of Series 11 are what we want to reproduce, we must pick the coefficient computed at series 10. 

.. code-block:: bash
    cp H2O_AE_DFT.s010.opt.xml H2O_AE_DFT.wfj.xml


At this point, one needs to uncomment the 3J in the wavefunction file and change the series number to 15 in the opt.xml file and resubmit again


.. code-block:: bash 
     mpirun -n 1 qmcpack Opt.xml | tee Opt.out
     qmca -q ev *.scalar.dat | sort -k4

                             LocalEnergy               Variance           ratio 
     H2O_AE_DFT  series 0  -75.374060 +/- 0.371321   6.717349 +/- 2.587564   0.0891 
     H2O_AE_DFT  series 1  -76.128852 +/- 0.038761   5.963490 +/- 0.174963   0.0783 
     H2O_AE_DFT  series 15  -76.164676 +/- 0.193024   3.079528 +/- 0.588058   0.0404 
     H2O_AE_DFT  series 18  -76.178938 +/- 0.013996   6.672877 +/- 0.116149   0.0876 
     H2O_AE_DFT  series 17  -76.311466 +/- 0.020733   4.622419 +/- 0.224774   0.0606 
     H2O_AE_DFT  series 10  -76.314322 +/- 0.013607   4.405358 +/- 0.182043   0.0577 
     H2O_AE_DFT  series 6  -76.321053 +/- 0.021226   4.649470 +/- 0.261492   0.0609 
     H2O_AE_DFT  series 5  -76.321748 +/- 0.011121   4.256483 +/- 0.126845   0.0558 
     H2O_AE_DFT  series 13  -76.328038 +/- 0.013470   4.260497 +/- 0.079198   0.0558 
     H2O_AE_DFT  series 9  -76.328197 +/- 0.013156   4.191349 +/- 0.101476   0.0549 
     H2O_AE_DFT  series 14  -76.329850 +/- 0.012077   4.531482 +/- 0.228191   0.0594 
     H2O_AE_DFT  series 2  -76.336262 +/- 0.027683   3.460298 +/- 0.111215   0.0453 
     H2O_AE_DFT  series 16  -76.341265 +/- 0.071827   4.347790 +/- 0.284500   0.0570 
     H2O_AE_DFT  series 4  -76.342807 +/- 0.019891   4.292159 +/- 0.129885   0.0562 
     H2O_AE_DFT  series 3  -76.344315 +/- 0.017467   4.026520 +/- 0.168988   0.0527 
     H2O_AE_DFT  series 8  -76.345056 +/- 0.014600   4.080318 +/- 0.060097   0.0534 
     H2O_AE_DFT  series 7  -76.346992 +/- 0.011128   4.299614 +/- 0.080107   0.0563 
     H2O_AE_DFT  series 11  -76.349011 +/- 0.012945   4.487658 +/- 0.088711   0.0588 
     H2O_AE_DFT  series 12  -76.368072 +/- 0.014845   4.313579 +/- 0.090184   0.0565 
     H2O_AE_DFT  series 27  -76.373757 +/- 0.008148   2.203106 +/- 0.080330   0.0288 
     H2O_AE_DFT  series 22  -76.373883 +/- 0.010398   2.347633 +/- 0.071127   0.0307 
     H2O_AE_DFT  series 23  -76.375095 +/- 0.013046   2.261811 +/- 0.120170   0.0296 
     H2O_AE_DFT  series 29  -76.377463 +/- 0.008902   2.459788 +/- 0.149225   0.0322 
     H2O_AE_DFT  series 20  -76.378593 +/- 0.010231   4.479266 +/- 1.922687   0.0586 
     H2O_AE_DFT  series 19  -76.382036 +/- 0.018650   2.661659 +/- 0.280192   0.0348 
     H2O_AE_DFT  series 28  -76.388138 +/- 0.008604   2.296048 +/- 0.109135   0.0301 
     H2O_AE_DFT  series 25  -76.392127 +/- 0.007138   2.556821 +/- 0.334158   0.0335 
     H2O_AE_DFT  series 21  -76.392933 +/- 0.007818   2.380255 +/- 0.082507   0.0312 
     H2O_AE_DFT  series 24  -76.394555 +/- 0.010593   2.089199 +/- 0.078011   0.0273 
     H2O_AE_DFT  series 26  -76.395727 +/- 0.013572   2.171732 +/- 0.092267   0.0284 
 
You will notice that the Variance improved significantly from not using a Jastrow to using a well converged Jastrow. 

While the Jastrow do not change the ndal surface for All electron calculations, They reduce significantly the variance, leading to a faster cnvergence at the DMC level


Step3- VMC DMC

The VMC directory contains the DMC.xml input file with a VMC block (to select better samples and reduce the DMC equilibration time)
and a DMC block. 

For production run, ne needs to adjust the number of blocks/targetwalkers to reach the desired accuracy. 
It is also necessary to copy the optimizedtrial wavefunction to the correct directory.
In this case and for the AWS, This will lead to the followin answers:

.. code-block:: bash
    cp Optimization/H2O_AE_DFT.s023.opt.xml DMC/H2O_AE_DFT.wfj.xml
    mpirun -n 1 qmcpack DMC.xml | tee DMC.out 
    qmca -q ev *.scalar.out

                             LocalEnergy               Variance           ratio 
    H2O_AE_DFT  series 0  -76.380929 +/- 0.051560   2.107357 +/- 0.329374   0.0276 
    H2O_AE_DFT  series 1  -76.417832 +/- 0.002178   2.314365 +/- 0.040821   0.0303 





