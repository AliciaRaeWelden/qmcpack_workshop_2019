Example 1: H2O with a DFT nodal surface and BFD ECP
====================

In this example we will go through the basic steps necessary to
generate DMC input from a pyscf calculation on a simple closed
shell molecule H2O with BFD ECP and the corresponding vtz basis set.

The pyscf scf script is given below (h2o_bfd_dft.py in the current directory):

.. code-block:: python

    from pyscf import gto
    from pyscf import scf, dft, df


    mol = gto.Mole()
    mol.verbose = 5
    mol.atom =''' 
      H             0.00000000       0.75720000      -0.46920000
      H             0.00000000      -0.75720000      -0.46920000
      O             0.00000000       0.00000000       0.11730000
    '''
    mol.unit='A'
    mol.basis = 'bfd_vtz'
    mol.ecp = 'bfd'
    mol.spin=0 #Value of S where the spin multiplicity is 2S+1
    mol.build()



    #Hartree Fock
    #mf = scf.ROHF(mol)

    #DFT
    mf = dft.ROKS(mol)
    mf.xc ='b3lyp' 

    e_scf=mf.kernel()

    #Section for QMCPACK
    title="H2O_DFT_BFD"
    from PyscfToQmcpack import savetoqmcpack
    savetoqmcpack(mol,mf,title=title)


It is important to note that Pyscf recognizes most of the XC functionals and basis sets. 
For a complete list of refer to Pyscf Manual in https://sunqm.github.io/pyscf/dft.html#

In this example we are using the ECP from Burkatzki, Fillipi and Dolg for O and H with their 
corresponding VTZ basis set. They can be found in the quantum chemistry format 
in http://www.burkatzki.com/pseudos/index.2.html



In order to generate the HDF5 necessary to run QMCPACK we call the function "savetoqmcpack" 
located in "qmcpack/src/QMCTools/PyscfToQmcpack.py".  
This will generate an HDF5 file named "$title.h5" (in this case H2O_DFT_BFD.h5) containing all 
information necessary to run QMCPACK. 
For this call to work, It is important to have "qmcpack/src/QMCTools/" in your PYTHONPATH.

We next run the pyscf calculation using

.. code-block:: bash

    python h2o_bfd_dft.py > h2o_bfd_dft.out

which will yield a converged restricted orbitals DFT total energy of -17.2466394215553 Ha 


The next step is to generate the necessary qmcpack input from this scf calculation. 

.. code-block:: bash

    mpirun -n 1 convert4qmc -pyscf H2O_DFT_BFD.h5 -production 

This operation will generate 3 files: 
  1- H2O_DFT_BFD.structure.xml (present in the directory)
	This file contains the system geometry, the number of atoms and the number of electrons.
 
  2- H2O_DFT_BFD.wfj.xml (present in the directory)
	This file contains the trial wavefunction. The basis set, MO coefficients and all non mutable 
        data are stored in the HDF5 file referenced in the trial wavefunction. Only Jastrow data and 
        important information is kept in the HDF5. This allows a lighter IO and more user friendly inputs.

  3- H2O_DFT_BFD.qmc.in.xml (present in the directory)
        This file contains what is considered a "standard production" QMC block, from the Jastrow Optimmization 
        blocks, to VMC and DMC blocks. 
        IMPORTANT NOTE: THIS BLOCKS ARE NOT TAILORED FOR THE PROBLEM, MACHINE OR ACCURACY YOU MAY WANT TO REACH
                        THEY ARE TO BE USED AS GUIDE LINES TO BE MODIFIED AS SEEN IN THE FOLLOWING SECTIONS.


In this example, convert4qmc takes 4 arguments;
   1- -pyscf: The code name generating the HDF5. Other options are -QP (quantum package) or -gamess. Note that 
      the option -orbitals is also available and reads natively hdf5 files generated by QP and Pyscf. 
   2- $title.h5: the name of the HDF5 file. 
   3- -production : This flag will force to generate a set of "GUESS" Optimization blocks and VMC and DMC blocks
      for production. Please Note that these blocks are mainly suggestions and should be adapted to the system,
      machine and desired accuracies.
       
You will need to add the ECP files in the XML for QMCPACK to use. These ECP files in the QMCPACK format are provided as H.qmcpp.xml 
and O.qmcpp.xml.

They appear in the H2O_DFT_BFD.qmc.in.xml file when defining the hamiltonian.

.. code-block:: xml
  <hamiltonian name="h0" type="generic" target="e">
    <pairpot name="ElecElec" type="coulomb" source="e" target="e" physical="true"/>
    <pairpot name="IonIon" type="coulomb" source="ion0" target="ion0"/>
    <pairpot name="PseudoPot" type="pseudo" source="ion0" wavefunction="psi0" format="xml">
      <pseudo elementType="H" href="../H.qmcpp.xml"/>
      <pseudo elementType="O" href="../O.qmcpp.xml"/>
    </pairpot>
  </hamiltonian>
 

Running QMC:

Step 1- Jastrow Optimization:
In the Optimization directory, we modify slightly the Jastrow to have 20 parameters for the 2 body Jastrow with a cutoff of 10 Angstrom 
and 10 parameters and a cutoff of 5 Angstrom for the one body Jastrow. 

Since the starting parameters for the optimization are significantly bad (0 0 0 0 0 ...) we use 2 loops with different values, 
from "aggressive" to more restrictive.  Note the difference between the used number of samples (8000->80000)  and the value of 
minwalker (0.0001->0.1) between in the input file

.. code-block:: xml
  <loop max="4">
    <qmc method="linear" move="pbyp" checkpoint="-1">
      <parameter name="samples">80000</parameter>
      <parameter name="minwalkers">0.1</parameter>
    </qmc>
  </loop>

The Jastrow Optimization should always be made in 2 steps. First optimizing 1 and 2 body Jastrow (No 3 Bodies), Then in a second 
step adding 3 body Jastrows. This will avoid having to optimize too many parameters in one run and introducing too much instability

In the Optimization directory you will find an Opt.xml file containing the optimization blocks (whill start enumerating outputs 
from 0 to 14). The enumeration is controlled with the tag:

.. code-block:: xml
 
  <project id="H2O_DFT_BFD" series="0"/>

The outcome of the optimization should generate 15 files named H2O_DFT_BFD.sXXX.scalar.dat where XXX=000..014
IMPORTANT: The optimized Jastrow Parameters will be in the H2O_DFT_BFD.sXXX.opt.xml files. These files can replace a wfj.xml Wavefunction
To select the est JAstrow Parameters they need to lead to the lowest VMC energy: 

.. code-block:: bash 
     mpirun -n 1 qmcpack Opt.xml | tee Opt.out
     qmca -q ev *.scalar.dat | sort -k4

                                  LocalEnergy               Variance           ratio 
     H2O_DFT_BFD  series 0  -16.917112 +/- 0.091249   2.206084 +/- 0.507540   0.1304 
     H2O_DFT_BFD  series 1  -16.952442 +/- 0.008993   2.552856 +/- 0.017657   0.1506 
     H2O_DFT_BFD  series 2  -17.203955 +/- 0.002632   0.449546 +/- 0.006093   0.0261 
     H2O_DFT_BFD  series 3  -17.221622 +/- 0.002985   0.433558 +/- 0.009227   0.0252 
     H2O_DFT_BFD  series 5  -17.222677 +/- 0.001852   0.456094 +/- 0.005915   0.0265 
     H2O_DFT_BFD  series 12  -17.222827 +/- 0.001848   0.460657 +/- 0.011720   0.0267 
     H2O_DFT_BFD  series 7  -17.224370 +/- 0.001626   0.474714 +/- 0.011704   0.0276 
     H2O_DFT_BFD  series 14  -17.224563 +/- 0.002599   0.481431 +/- 0.018505   0.0280 
     H2O_DFT_BFD  series 6  -17.224641 +/- 0.002245   0.464094 +/- 0.013082   0.0269 
     H2O_DFT_BFD  series 13  -17.225089 +/- 0.002650   0.478029 +/- 0.007099   0.0278 
     H2O_DFT_BFD  series 9  -17.226046 +/- 0.001791   0.488931 +/- 0.016957   0.0284 
     H2O_DFT_BFD  series 4  -17.226620 +/- 0.002564   0.474710 +/- 0.010913   0.0276 
     H2O_DFT_BFD  series 10  -17.227309 +/- 0.002985   0.475297 +/- 0.017481   0.0276 
     H2O_DFT_BFD  series 11  -17.228171 +/- 0.002130   0.462997 +/- 0.008928   0.0269 
     H2O_DFT_BFD  series 8  -17.229854 +/- 0.009619   0.431436 +/- 0.004379   0.0250 


Series 08 seems to give the lowest energy. In the case, the energy in the series 08 was computed using the Jastrow from the previous round. 
Explanation: At the end of an optimization block N, we generate a series of Jastrow parameters. These will be used to evaluate a VMC energy at Loop N+1.
Therefore if the Energy of Series 08 are what we want to reproduce, we must pick the coefficient computed at series 07

.. code-block:: bash
    cp H2O_DFT_BFD.s007.opt.xml H2O_DFT_BFD.wfj.xml


At this point, one needs to uncomment the 3J in the wavefunction file and change the series number to 15 in the opt.xml file and resubmit again


.. code-block:: bash 
     mpirun -n 1 qmcpack Opt.xml | tee Opt.out
     qmca -q ev *.scalar.dat | sort -k4

                                  LocalEnergy               Variance           ratio 
     H2O_DFT_BFD  series 0  -16.917112 +/- 0.091249   2.206084 +/- 0.507540   0.1304 
     H2O_DFT_BFD  series 1  -16.952442 +/- 0.008993   2.552856 +/- 0.017657   0.1506 
     H2O_DFT_BFD  series 15  -17.178117 +/- 0.063800   0.276239 +/- 0.051467   0.0161 
     H2O_DFT_BFD  series 2  -17.203955 +/- 0.002632   0.449546 +/- 0.006093   0.0261 
     H2O_DFT_BFD  series 19  -17.216962 +/- 0.003117   0.609390 +/- 0.007641   0.0354 
     H2O_DFT_BFD  series 3  -17.221622 +/- 0.002985   0.433558 +/- 0.009227   0.0252 
     H2O_DFT_BFD  series 5  -17.222677 +/- 0.001852   0.456094 +/- 0.005915   0.0265 
     H2O_DFT_BFD  series 12  -17.222827 +/- 0.001848   0.460657 +/- 0.011720   0.0267 
     H2O_DFT_BFD  series 7  -17.224370 +/- 0.001626   0.474714 +/- 0.011704   0.0276 
     H2O_DFT_BFD  series 14  -17.224563 +/- 0.002599   0.481431 +/- 0.018505   0.0280 
     H2O_DFT_BFD  series 6  -17.224641 +/- 0.002245   0.464094 +/- 0.013082   0.0269 
     H2O_DFT_BFD  series 13  -17.225089 +/- 0.002650   0.478029 +/- 0.007099   0.0278 
     H2O_DFT_BFD  series 9  -17.226046 +/- 0.001791   0.488931 +/- 0.016957   0.0284 
     H2O_DFT_BFD  series 16  -17.226073 +/- 0.002456   0.466268 +/- 0.009573   0.0271 
     H2O_DFT_BFD  series 4  -17.226620 +/- 0.002564   0.474710 +/- 0.010913   0.0276 
     H2O_DFT_BFD  series 10  -17.227309 +/- 0.002985   0.475297 +/- 0.017481   0.0276 
     H2O_DFT_BFD  series 11  -17.228171 +/- 0.002130   0.462997 +/- 0.008928   0.0269 
     H2O_DFT_BFD  series 8  -17.229854 +/- 0.009619   0.431436 +/- 0.004379   0.0250 
     H2O_DFT_BFD  series 21  -17.234906 +/- 0.001583   0.402230 +/- 0.003977   0.0233 
     H2O_DFT_BFD  series 18  -17.236017 +/- 0.002675   0.385650 +/- 0.006869   0.0224 
     H2O_DFT_BFD  series 28  -17.236995 +/- 0.001482   0.380467 +/- 0.005228   0.0221 
     H2O_DFT_BFD  series 24  -17.237332 +/- 0.001446   0.424339 +/- 0.007657   0.0246 
     H2O_DFT_BFD  series 26  -17.237824 +/- 0.001548   0.395232 +/- 0.008362   0.0229 
     H2O_DFT_BFD  series 29  -17.238078 +/- 0.001366   0.411559 +/- 0.008788   0.0239 
     H2O_DFT_BFD  series 20  -17.238988 +/- 0.002073   0.420054 +/- 0.007020   0.0244 
     H2O_DFT_BFD  series 25  -17.239046 +/- 0.001913   0.397342 +/- 0.014986   0.0230 
     H2O_DFT_BFD  series 17  -17.239803 +/- 0.002399   0.401429 +/- 0.012750   0.0233 
     H2O_DFT_BFD  series 23  -17.240150 +/- 0.001502   0.396726 +/- 0.005160   0.0230 
     H2O_DFT_BFD  series 22  -17.241260 +/- 0.001667   0.418435 +/- 0.009165   0.0243 
     H2O_DFT_BFD  series 27  -17.242482 +/- 0.001551   0.408790 +/- 0.006770   0.0237 

You will notice that the Variance did not improve significantly from not using a Jastrow to using a well converged Jastrow. The reason is that using ECP 
reduces significantly the variance when compared to all electrons, therefore the gain from the Jastrow is reduced. 



Step2- VMC DMC

The VMC directory contains the DMC.xml input file with a VMC block (to select better samples and reduce the DMC equilibration time)
and a DMC block. 

For production run, ne needs to adjust the number of blocks/targetwalkers to reach the desired accuracy. 
It is also necessary to copy the optimizedtrial wavefunction to the correct directory.
In this case and for the AWS, This will lead to the followin answers:

.. code-block:: bash
    cp Optimization/H2O_DFT_BFD.s026.opt.xml DMC/H2O_DFT_BFD.wfj.xml
    mpirun -n 1 qmcpack DMC.xml | tee DMC.out 
    qmca -q ev *.scalar.out

                               LocalEnergy               Variance           ratio 
    H2O_DFT_BFD  series 0  -17.267279 +/- 0.015368   0.368301 +/- 0.047889   0.0213 
    H2O_DFT_BFD  series 1  -17.270029 +/- 0.002751   0.421050 +/- 0.006122   0.0244 





