Example 1: H2O All Electron with a HF nodal surface
====================

In this example we will go through the basic steps necessary to
generate DMC input from a pyscf calculation on a simple closed
shell molecule H2O in all electrons and the cc-pvtz basis set.

The pyscf scf script is given below (h2o_ae_hf.py in the current directory):

.. code-block:: python

    from pyscf import gto
    from pyscf import scf, hf, df


    mol = gto.Mole()
    mol.verbose = 5
    mol.atom =''' 
      H             0.00000000       0.75720000      -0.46920000
      H             0.00000000      -0.75720000      -0.46920000
      O             0.00000000       0.00000000       0.11730000
    '''
    mol.unit='A'
    mol.basis = 'cc-pvtz'
    #mol.pseudo = 'bfd-vtz'
    mol.spin=0 #Value of S where the spin multiplicity is 2S+1
    mol.build()



    #Hartree Fock
    mf = scf.ROHF(mol)

    #HF
    #mf = hf.ROKS(mol)
    #mf.xc ='b3lyp' 

    e_scf=mf.kernel()

    #Section for QMCPACK
    title="H2O_AE_HF"
    from PyscfToQmcpack import savetoqmcpack
    savetoqmcpack(mol,mf,title=title)


It is important to note that Pyscf recognizes most of the usual basis sets. 
For a complete list of refer to Pyscf Manual in https://sunqm.github.io/pyscf/hf.html#

In order to generate the HDF5 necessary to run QMCPACK we call the function "savetoqmcpack" 
located in "qmcpack/src/QMCTools/PyscfToQmcpack.py".  
This will generate an HDF5 file named "$title.h5" (in this case H2O_AE_HF.h5) containing all 
information necessary to run QMCPACK. 
For this call to work, It is important to have "qmcpack/src/QMCTools/" in your PYTHONPATH.

We next run the pyscf calculation using

.. code-block:: bash

    python h2o_ae_hf.py > h2o_ae_hf.out 

which will yield a converged restricted orbitals HF total energy of -76.0571274202736 Ha.  


The next step is to generate the necessary qmcpack input from this scf calculation. 

.. code-block:: bash

    mpirun -n 1 convert4qmc -pyscf H2O_AE_HF.h5 -production -addCusp

This operation will generate 3 files: 
  1- H2O_AE_HF.structure.xml (present in the directory)
	This file contains the system geometry, the number of atoms and the number of electrons.
 
  2- H2O_AE_HF.wfj.xml (present in the directory)
	This file contains the trial wavefunction. The basis set, MO coefficients and all non mutable 
        data are stored in the HDF5 file referenced in the trial wavefunction. Only Jastrow data and 
        important information is kept in the HDF5. This allows a lighter IO and more user friendly inputs.

  3- H2O_AE_HF.qmc.in.xml (present in the directory)
        This file contains what is considered a "standard production" QMC block, from the Jastrow Optimmization 
        blocks, to VMC and DMC blocks. 
        IMPORTANT NOTE: THIS BLOCKS ARE NOT TAILORED FOR THE PROBLEM, MACHINE OR ACCURACY YOU MAY WANT TO REACH
                        THEY ARE TO BE USED AS GUIDE LINES TO BE MODIFIED AS SEEN IN THE FOLLOWING SECTIONS.


In this example, convert4qmc takes 4 arguments;
   1- -pyscf: The code name generating the HDF5. Other options are -QP (quantum package) or -gamess. Note that 
      the option -orbitals is also available and reads natively hdf5 files generated by QP and Pyscf. 
   2- $title.h5: the name of the HDF5 file. 
   3- -production : This flag will force to generate a set of "GUESS" Optimization blocks and VMC and DMC blocks
      for production. Please Note that these blocks are mainly suggestions and should be adapted to the system,
      machine and desired accuracies.
   4- -addCusp:  Since we are running an all electron calculation, we need a scheme to forbid electrons to move 
       too close to the nuclei. Adding this tag will modify the orbitals and will add a cusp correction to the orbitals.
       in the Trial Wave function file the Cusp Correction scheme is triggered by the following lines:    
       
.. code-block:: xml
    <determinantset type="MolecularOrbital" name="LCAOBSet" source="ion0" transform="yes" cuspCorrection="yes" href="../H2O_AE_HF.h5">
The tag CuspCorrection=yes will call the CuspCorrection. 

The Cusp Correction will be done for the orbotals in spin up and orbitals in spin down. While this operation is relatively fast for 
small molecules, specially when only occupied orbitals are to be considered, it might be necessary store the correction parameters. 
If already stored, the parameters (updet.cuspInfo.xml and downdet.cuspInfo.xml) can be speicified as follow in the wfj.xml file:

.. code-block:: xml
        <determinant id="updet" size="5" cuspInfo="../CuspCorrection/updet.cuspInfo.xml">


Running QMC:
Step 1- CuspCorrection AND a VMC block with No Jastrow to compare our result to HF (files in ref_files/CuspCorrection.
   
.. code-block:: bash 
      cd CuspCorrection
      mpirun -n 1 qmcpack Cusp.xml | tee Cusp.out

NOTE: Compare carefully the Cusp.xml and H2O_AE_HF.wfj.xml files (provided in the directory) and the H2O_AE_HF.qmc.in.xml and 
H2O_AE_HF.wfj.xml  generated by convert4qmc. You will notice the lack of Jastrow functions (to capture only the Antysymmetric 
part of the trial wavefunction and a longer than necessary VMC block to compare to the HF Energy.   

HF energy: -76.0571274202736 Ha.
.. code-block:: bash 
     qmca -q ev *.scalar.dat
                            LocalEnergy               Variance           ratio 
H2O_AE_HF  series 0   -76.061252 +/- 0.008513   17.414698 +/- 0.424133   0.2290

You will notice that the HF energy and the VMC energy are the same (within error bar). This is a good test to make sure that your TWF is not broken


 

Step 2- Jastrow Optimization:
In the Optimization directory, we modify slightly the Jastrow to have 20 parameters for the 2 body Jastrow with a cutoff of 10 Angstrom 
and 10 parameters and a cutoff of 5 Angstrom for the one body Jastrow. 

Since the starting parameters for the optimization are significantly bad (0 0 0 0 0 ...) we use 2 loops with different values, 
from "aggressive" to more restrictive.  Note the difference between the used number of samples (8000->80000)  and the value of 
minwalker (0.0001->0.1) between in the input file

.. code-block:: xml
  <loop max="4">
    <qmc method="linear" move="pbyp" checkpoint="-1">
      <parameter name="samples">80000</parameter>
      <parameter name="minwalkers">0.1</parameter>
    </qmc>
  </loop>

The Jastrow Optimization should always be made in 2 steps. First optimizing 1 and 2 body Jastrow (No 3 Bodies), Then in a second 
step adding 3 body Jastrows. This will avoid having to optimize too many parameters in one run and introducing too much instability

In the Optimization directory you will find an Opt.xml file containing the optimization blocks (whill start enumerating outputs 
from 0 to 14). The enumeration is controlled with the tag:

.. code-block:: xml
 
  <project id="H2O_AE_HF" series="0"/>

The outcome of the optimization should generate 15 files named H2O_AE_HF.sXXX.scalar.dat where XXX=000..014
IMPORTANT: The optimized Jastrow Parameters will be in the H2O_AE_HF.sXXX.opt.xml files. These files can replace a wfj.xml Wavefunction
To select the est JAstrow Parameters they need to lead to the lowest VMC energy: 

.. code-block:: bash 
     mpirun -n 1 qmcpack Opt.xml | tee Opt.out
     qmca -q ev *.scalar.dat | sort -k4

                            LocalEnergy               Variance           ratio 
H2O_AE_HF  series 0  -76.094525 +/- 0.203709   4.666860 +/- 0.751118   0.0613 
H2O_AE_HF  series 1  -76.146370 +/- 0.029200   5.617017 +/- 0.392917   0.0738 
H2O_AE_HF  series 2  -76.285037 +/- 0.028197   3.474637 +/- 0.189607   0.0455 
H2O_AE_HF  series 12  -76.306924 +/- 0.016317   4.220181 +/- 0.076253   0.0553 
H2O_AE_HF  series 6  -76.311538 +/- 0.011163   4.295774 +/- 0.094510   0.0563 
H2O_AE_HF  series 9  -76.317560 +/- 0.015822   4.312408 +/- 0.110286   0.0565 
H2O_AE_HF  series 3  -76.327954 +/- 0.016725   4.323127 +/- 0.163993   0.0566 
H2O_AE_HF  series 7  -76.332964 +/- 0.012753   4.250972 +/- 0.104201   0.0557 
H2O_AE_HF  series 10  -76.333039 +/- 0.013017   6.139041 +/- 1.651920   0.0804 
H2O_AE_HF  series 13  -76.333829 +/- 0.013589   4.663982 +/- 0.320562   0.0611 
H2O_AE_HF  series 8  -76.335588 +/- 0.012295   4.593165 +/- 0.327048   0.0602 
H2O_AE_HF  series 14  -76.337370 +/- 0.010721   4.221984 +/- 0.085601   0.0553 
H2O_AE_HF  series 11  -76.345180 +/- 0.016736   4.508993 +/- 0.199596   0.0591 
H2O_AE_HF  series 4  -76.348618 +/- 0.023381   4.275737 +/- 0.127029   0.0560 
H2O_AE_HF  series 5  -76.350059 +/- 0.013598   4.874320 +/- 0.527826   0.0638 


In this case Series 4 and 5 while being the lowest in energy  seems to behave as  outlayers (too low compared to all other runs,  
discard it as an outlayer.

Series 11 seems to be better. In the case, the energy in the series 11 was computed using the Jastrow from the previous round. 
Explanation: At the end of an optimization block N, we generate a series of Jastrow parameters. These will be used to evaluate a VMC energy at Loop N+1.
Therefore if the Energy of Series 11 are what we want to reproduce, we must pick the coefficient computed at series 10. 

.. code-block:: bash
    cp H2O_AE_HF.s010.opt.xml H2O_AE_HF.wfj.xml


At this point, one needs to uncomment the 3J in the wavefunction file and change the series number to 15 in the opt.xml file and resubmit again


.. code-block:: bash 
     mpirun -n 1 qmcpack Opt.xml | tee Opt.out
     qmca -q ev *.scalar.dat | sort -k4

                            LocalEnergy               Variance           ratio 
H2O_AE_HF  series 15  -75.839402 +/- 0.139824   2.561530 +/- 0.872180   0.0338 
H2O_AE_HF  series 0  -76.094525 +/- 0.203709   4.666860 +/- 0.751118   0.0613 
H2O_AE_HF  series 1  -76.146370 +/- 0.029200   5.617017 +/- 0.392917   0.0738 
H2O_AE_HF  series 2  -76.285037 +/- 0.028197   3.474637 +/- 0.189607   0.0455 
H2O_AE_HF  series 12  -76.306924 +/- 0.016317   4.220181 +/- 0.076253   0.0553 
H2O_AE_HF  series 6  -76.311538 +/- 0.011163   4.295774 +/- 0.094510   0.0563 
H2O_AE_HF  series 9  -76.317560 +/- 0.015822   4.312408 +/- 0.110286   0.0565 
H2O_AE_HF  series 3  -76.327954 +/- 0.016725   4.323127 +/- 0.163993   0.0566 
H2O_AE_HF  series 7  -76.332964 +/- 0.012753   4.250972 +/- 0.104201   0.0557 
H2O_AE_HF  series 10  -76.333039 +/- 0.013017   6.139041 +/- 1.651920   0.0804 
H2O_AE_HF  series 13  -76.333829 +/- 0.013589   4.663982 +/- 0.320562   0.0611 
H2O_AE_HF  series 8  -76.335588 +/- 0.012295   4.593165 +/- 0.327048   0.0602 
H2O_AE_HF  series 14  -76.337370 +/- 0.010721   4.221984 +/- 0.085601   0.0553 
H2O_AE_HF  series 11  -76.345180 +/- 0.016736   4.508993 +/- 0.199596   0.0591 
H2O_AE_HF  series 4  -76.348618 +/- 0.023381   4.275737 +/- 0.127029   0.0560 
H2O_AE_HF  series 5  -76.350059 +/- 0.013598   4.874320 +/- 0.527826   0.0638 
H2O_AE_HF  series 17  -76.359492 +/- 0.017303   5.888800 +/- 2.082907   0.0771 
H2O_AE_HF  series 16  -76.373118 +/- 0.026014   4.392001 +/- 0.101830   0.0575 
H2O_AE_HF  series 27  -76.378410 +/- 0.008433   2.326149 +/- 0.145645   0.0305 
H2O_AE_HF  series 20  -76.380868 +/- 0.009555   2.417767 +/- 0.135159   0.0317 
H2O_AE_HF  series 29  -76.381248 +/- 0.009328   2.643215 +/- 0.195850   0.0346 
H2O_AE_HF  series 24  -76.384637 +/- 0.010273   2.645572 +/- 0.420371   0.0346 
H2O_AE_HF  series 28  -76.385055 +/- 0.008862   2.502299 +/- 0.195823   0.0328 
H2O_AE_HF  series 22  -76.385684 +/- 0.011006   2.704849 +/- 0.483430   0.0354 
H2O_AE_HF  series 26  -76.387982 +/- 0.011247   2.248545 +/- 0.092678   0.0294 
H2O_AE_HF  series 19  -76.389083 +/- 0.013067   2.697288 +/- 0.420681   0.0353 
H2O_AE_HF  series 21  -76.389947 +/- 0.008046   2.365721 +/- 0.140024   0.0310 
H2O_AE_HF  series 23  -76.395522 +/- 0.008655   2.464047 +/- 0.153699   0.0323 
H2O_AE_HF  series 25  -76.397649 +/- 0.009195   2.900794 +/- 0.554031   0.0380 
H2O_AE_HF  series 18  -76.397808 +/- 0.011141   2.240685 +/- 0.113705   0.0293 
 

You will notice that the Variance improved significantly from not using a Jastrow to using a well converged Jastrow. 

While the Jastrow do not change the ndal surface for All electron calculations, They reduce significantly the variance, leading to a faster cnvergence at the DMC level


Step3- VMC DMC

The VMC directory contains the DMC.xml input file with a VMC block (to select better samples and reduce the DMC equilibration time)
and a DMC block. 

For production run, ne needs to adjust the number of blocks/targetwalkers to reach the desired accuracy. 
It is also necessary to copy the optimizedtrial wavefunction to the correct directory.
In this case and for the AWS, This will lead to the followin answers:

.. code-block:: bash
    cp Optimization/H2O_AE_HF.s024.opt.xml DMC/H2O_AE_HF.wfj.xml
    mpirun -n 1 qmcpack DMC.xml | tee DMC.out 
    qmca -q ev *.scalar.out

                            LocalEnergy               Variance           ratio 
H2O_AE_HF  series 0  -76.377514 +/- 0.039733   1.936965 +/- 0.236859   0.0254 
H2O_AE_HF  series 1  -76.413686 +/- 0.002511   2.314290 +/- 0.044349   0.0303 





