#INFO: **** input file is /p/lustre2/malone14/qmcpack_workshop_2019/day1_afqmc/06-diamond_2x2x2_supercell/scf.py ****
import numpy
import pyscf.pbc.gto as gto
from pyscf.pbc import scf, dft
import h5py
import sys

cell = gto.Cell()
cell.verbose = 5
alat0 = 3.6
cell.a = (numpy.ones((3,3))-numpy.eye(3))*alat0 / 2.0
cell.atom = (('C',0,0,0),('C',numpy.array([0.25,0.25,0.25])*alat0))
cell.basis = 'gth-szv'
cell.pseudo = 'gth-pade'
cell.mesh = [25,25,25]
cell.build()
nk = [2,2,2]
kpts = cell.make_kpts(nk)

mf = scf.KRHF(cell, kpts=kpts)
mf.chkfile = 'scf.chk'
mf.kernel()

from afqmctools.utils.linalg import get_ortho_ao
hcore = mf.get_hcore()
fock = (hcore + mf.get_veff())
X, nmo_per_kpt = get_ortho_ao(cell,kpts,1e-14)
with h5py.File(mf.chkfile) as fh5:
  fh5['scf/hcore'] = hcore
  fh5['scf/fock'] = fock
  fh5['scf/orthoAORot'] = X
  fh5['scf/nmo_per_kpt'] = nmo_per_kpt
#INFO: ******************** input file end ********************


System: ('Linux', 'quartz1922', '3.10.0-957.5.1.3chaos.ch6.x86_64', '#1 SMP Tue Feb 26 14:19:40 PST 2019', 'x86_64', 'x86_64')  Threads 72
Python 2.7.14 (default, Jan 17 2018, 10:04:29) 
[GCC 4.9.3]
numpy 1.13.3  scipy 1.0.0
Date: Sun May  5 15:30:48 2019
PySCF version 1.6.1
PySCF path  /g/g90/malone14/projects/pyscf/pyscf
GIT ORIG_HEAD b9c7026dea665ddc2f3c0ac57ca8c5c630ee17bc
GIT HEAD      ref: refs/heads/master
GIT master branch  b9c7026dea665ddc2f3c0ac57ca8c5c630ee17bc

[CONFIG] conf_file None
[INPUT] verbose = 5
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 2
[INPUT] num. electrons = 8
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT]  1 C      0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr
[INPUT]  2 C      0.900000000000   0.900000000000   0.900000000000 AA    1.700753512109   1.700753512109   1.700753512109 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] C
[INPUT] 0    0    [4    /1   ]  4.3362376436      0.1490797872
                                1.2881838513      -0.0292640031
                                0.4037767149      -0.688204051
                                0.1187877657      -0.3964426906
[INPUT] 1    0    [4    /1   ]  4.3362376436      -0.0878123619
                                1.2881838513      -0.27755603
                                0.4037767149      -0.4712295093
                                0.1187877657      -0.4058039291

Ewald components = 2.62511131804051e-13, -33.8075273415067, 21.1383239417488
nuclear repulsion = -12.6692033997576
number of shells = 4
number of NR pGTOs = 32
number of NR cGTOs = 8
basis = gth-szv
ecp = {}
CPU time:         0.59
lattice vectors  a1 [0.000000000, 3.401507024, 3.401507024]
                 a2 [3.401507024, 0.000000000, 3.401507024]
                 a3 [3.401507024, 3.401507024, 0.000000000]
dimension = 3
low_dim_ft_type = None
Cell volume = 78.7126
rcut = 19.7932586752 (nimgs = [6 6 6])
lattice sum = 911 cells
precision = 1e-08
pseudo = gth-pade
mesh = [25, 25, 25] (15625 PWs)
    = ke_cutoff [ 199.9255439  199.9255439  199.9255439]
ew_eta = 1.85194
ew_cut = 3.71268758401 (nimgs = [1 1 1])


******** <class 'pyscf.pbc.scf.khf.KRHF'> ********
method = KRHF-KSCF-RHF-SCF-RHF
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-07
SCF gradient tol = None
max. SCF cycles = 50
direct_scf = False
chkfile to save SCF result = scf.chk
max_memory 4000 MB (current use 57 MB)


******** PBC SCF flags ********
N kpts = 8
kpts = [[ 0.          0.          0.        ]
 [ 0.46179423  0.46179423 -0.46179423]
 [ 0.46179423 -0.46179423  0.46179423]
 [ 0.92358847  0.          0.        ]
 [-0.46179423  0.46179423  0.46179423]
 [ 0.          0.92358847  0.        ]
 [ 0.          0.          0.92358847]
 [ 0.46179423  0.46179423  0.46179423]]
Exchange divergence treatment (exxdiv) = ewald
Ewald components = 1.35350024670892e-151, -1.08740537387457, 0.918918948338747
    madelung (= occupied orbital energy shift) = 0.336972851072
    Total energy shift due to Ewald probe charge = -1/2 * Nelec*madelung = -1.34789140429
DF object = <pyscf.pbc.df.fft.FFTDF object at 0x2aaac5b01e90>


******** <class 'pyscf.pbc.df.fft.FFTDF'> ********
mesh = [25, 25, 25] (15625 PWs)
len(kpts) = 8
Set gradient conv threshold to 0.000316228
Big error detected in the electron number of initial guess density matrix (Ne/cell = 7.93646)!
  This can cause huge error in Fock matrix and lead to instability in SCF for low-dimensional systems.
  DM is normalized wrt the number of electrons 8.0
cond(S) = [ 26.99407411  19.51424495  19.51424495   8.55250357  19.51424495
   8.55250357   8.55250357  19.51424495]
Ewald components = 1.35350024670892e-151, -1.08740537387457, 0.918918948338747
    CPU time for vj and vk    427.00 sec, wall time      7.08 sec
E1 = (3.7257229385+9.47847047239e-19j)  E_coul = (-3.39536615887+2.09708198524e-16j)
Ewald components = 2.62511131804051e-13, -33.8075273415067, 21.1383239417488
init E= -12.3388466201351
    CPU time for initialize scf    444.23 sec, wall time      7.67 sec
HOMO = 0.603316026079  LUMO = 0.897393602527
     k-point                  mo_energy
   0 ( 0.000  0.000  0.000)   [-1.91936751  0.60331603  0.60331603  0.60331603] [ 0.8973936   0.8973936   0.8973936   1.16068673]
   1 ( 0.000  0.000  0.500)   [-0.73620349 -0.45582017  0.44777996  0.44777996] [ 1.0036669   1.08681004  1.08681004  1.48677934]
   2 ( 0.000  0.500  0.000)   [-0.73620349 -0.45582017  0.44777996  0.44777996] [ 1.0036669   1.08681004  1.08681004  1.48677934]
   3 ( 0.000  0.500  0.500)   [-0.38571728 -0.38571728  0.23732006  0.23732006] [ 0.95738818  0.95738818  1.37159331  1.37159331]
   4 ( 0.500  0.000  0.000)   [-0.73620349 -0.45582017  0.44777996  0.44777996] [ 1.0036669   1.08681004  1.08681004  1.48677934]
   5 ( 0.500  0.000  0.500)   [-0.38571728 -0.38571728  0.23732006  0.23732006] [ 0.95738818  0.95738818  1.37159331  1.37159331]
   6 ( 0.500  0.500  0.000)   [-0.38571728 -0.38571728  0.23732006  0.23732006] [ 0.95738818  0.95738818  1.37159331  1.37159331]
   7 ( 0.500  0.500  0.500)   [-0.73620349 -0.45582017  0.44777996  0.44777996] [ 1.0036669   1.08681004  1.08681004  1.48677934]
Ewald components = 1.35350024670892e-151, -1.08740537387457, 0.918918948338747
    CPU time for vj and vk    174.14 sec, wall time      2.89 sec
E1 = (3.99525105213+7.88682416104e-19j)  E_coul = (-2.25466270108+1.53730292263e-16j)
Ewald components = 2.62511131804051e-13, -33.8075273415067, 21.1383239417488
cycle= 1 E= -10.9286150487079  delta_E= 1.41  |g|= 0.283  |ddm|= 10.1
    CPU time for cycle= 1    174.17 sec, wall time      2.92 sec
HOMO = 0.323834448432  LUMO = 0.98631206923
     k-point                  mo_energy
   0 ( 0.000  0.000  0.000)   [-0.66897835  0.32383445  0.32383445  0.32383445] [ 0.98631207  0.98631207  0.98631207  1.34317365]
   1 ( 0.000  0.000  0.500)   [-0.4153817  -0.24617371  0.19654019  0.19654019] [ 1.16143177  1.16555897  1.16555897  1.56575832]
   2 ( 0.000  0.500  0.000)   [-0.4153817  -0.24617371  0.19654019  0.19654019] [ 1.16143177  1.16555897  1.16555897  1.56575832]
   3 ( 0.000  0.500  0.500)   [-0.26257306 -0.26257306  0.04631268  0.04631268] [ 1.0861672   1.0861672   1.44388316  1.44388316]
   4 ( 0.500  0.000  0.000)   [-0.4153817  -0.24617371  0.19654019  0.19654019] [ 1.16143177  1.16555897  1.16555897  1.56575832]
   5 ( 0.500  0.000  0.500)   [-0.26257306 -0.26257306  0.04631268  0.04631268] [ 1.0861672   1.0861672   1.44388316  1.44388316]
   6 ( 0.500  0.500  0.000)   [-0.26257306 -0.26257306  0.04631268  0.04631268] [ 1.0861672   1.0861672   1.44388316  1.44388316]
   7 ( 0.500  0.500  0.500)   [-0.4153817  -0.24617371  0.19654019  0.19654019] [ 1.16143177  1.16555897  1.16555897  1.56575832]
Ewald components = 1.35350024670892e-151, -1.08740537387457, 0.918918948338747
    CPU time for vj and vk    492.73 sec, wall time      7.68 sec
E1 = (3.99852449521+8.0379256321e-19j)  E_coul = (-2.26190339972+1.49062925045e-16j)
Ewald components = 2.62511131804051e-13, -33.8075273415067, 21.1383239417488
cycle= 2 E= -10.9325823042694  delta_E= -0.00397  |g|= 0.0714  |ddm|= 0.447
    CPU time for cycle= 2    492.75 sec, wall time      7.71 sec
HOMO = 0.321237044936  LUMO = 0.984391613382
     k-point                  mo_energy
   0 ( 0.000  0.000  0.000)   [-0.66888948  0.32123704  0.32123704  0.32123704] [ 0.98439161  0.98439161  0.98439161  1.34812138]
   1 ( 0.000  0.000  0.500)   [-0.4135185  -0.24827836  0.19392542  0.19392542] [ 1.16333032  1.16333032  1.16520304  1.56391546]
   2 ( 0.000  0.500  0.000)   [-0.4135185  -0.24827836  0.19392542  0.19392542] [ 1.16333032  1.16333032  1.16520304  1.56391546]
   3 ( 0.000  0.500  0.500)   [-0.26222921 -0.26222921  0.04346467  0.04346467] [ 1.0872929   1.0872929   1.44135527  1.44135527]
   4 ( 0.500  0.000  0.000)   [-0.4135185  -0.24827836  0.19392542  0.19392542] [ 1.16333032  1.16333032  1.16520304  1.56391546]
   5 ( 0.500  0.000  0.500)   [-0.26222921 -0.26222921  0.04346467  0.04346467] [ 1.0872929   1.0872929   1.44135527  1.44135527]
   6 ( 0.500  0.500  0.000)   [-0.26222921 -0.26222921  0.04346467  0.04346467] [ 1.0872929   1.0872929   1.44135527  1.44135527]
   7 ( 0.500  0.500  0.500)   [-0.4135185  -0.24827836  0.19392542  0.19392542] [ 1.16333032  1.16333032  1.16520304  1.56391546]
Ewald components = 1.35350024670892e-151, -1.08740537387457, 0.918918948338747
    CPU time for vj and vk    296.19 sec, wall time      4.71 sec
E1 = (4.00074885463+8.1583142438e-19j)  E_coul = (-2.2644257982+1.41308704867e-16j)
Ewald components = 2.62511131804051e-13, -33.8075273415067, 21.1383239417488
cycle= 3 E= -10.9328803433334  delta_E= -0.000298  |g|= 0.00428  |ddm|= 0.154
    CPU time for cycle= 3    296.21 sec, wall time      4.74 sec
HOMO = 0.321231298244  LUMO = 0.984203285484
     k-point                  mo_energy
   0 ( 0.000  0.000  0.000)   [-0.66887131  0.3212313   0.3212313   0.3212313 ] [ 0.98420329  0.98420329  0.98420329  1.34820725]
   1 ( 0.000  0.000  0.500)   [-0.41325086 -0.24835887  0.19387281  0.19387281] [ 1.16314928  1.16314928  1.16524609  1.56365858]
   2 ( 0.000  0.500  0.000)   [-0.41325086 -0.24835887  0.19387281  0.19387281] [ 1.16314928  1.16314928  1.16524609  1.56365858]
   3 ( 0.000  0.500  0.500)   [-0.26200958 -0.26200958  0.04338311  0.04338311] [ 1.08705923  1.08705923  1.44119439  1.44119439]
   4 ( 0.500  0.000  0.000)   [-0.41325086 -0.24835887  0.19387281  0.19387281] [ 1.16314928  1.16314928  1.16524609  1.56365858]
   5 ( 0.500  0.000  0.500)   [-0.26200958 -0.26200958  0.04338311  0.04338311] [ 1.08705923  1.08705923  1.44119439  1.44119439]
   6 ( 0.500  0.500  0.000)   [-0.26200958 -0.26200958  0.04338311  0.04338311] [ 1.08705923  1.08705923  1.44119439  1.44119439]
   7 ( 0.500  0.500  0.500)   [-0.41325086 -0.24835887  0.19387281  0.19387281] [ 1.16314928  1.16314928  1.16524609  1.56365858]
Ewald components = 1.35350024670892e-151, -1.08740537387457, 0.918918948338747
    CPU time for vj and vk    210.71 sec, wall time      3.42 sec
E1 = (4.00088433749+8.17547162883e-19j)  E_coul = (-2.26456227002+1.42112907212e-16j)
Ewald components = 2.62511131804051e-13, -33.8075273415067, 21.1383239417488
cycle= 4 E= -10.93288133229  delta_E= -9.89e-07  |g|= 6.9e-05  |ddm|= 0.0086
    CPU time for cycle= 4    210.75 sec, wall time      3.46 sec
HOMO = 0.321222491223  LUMO = 0.984198164081
     k-point                  mo_energy
   0 ( 0.000  0.000  0.000)   [-0.66889341  0.32122249  0.32122249  0.32122249] [ 0.98419816  0.98419816  0.98419816  1.34821238]
   1 ( 0.000  0.000  0.500)   [-0.41329452 -0.2483746   0.19386251  0.19386251] [ 1.16314613  1.16314613  1.16525103  1.56368119]
   2 ( 0.000  0.500  0.000)   [-0.41329452 -0.2483746   0.19386251  0.19386251] [ 1.16314613  1.16314613  1.16525103  1.56368119]
   3 ( 0.000  0.500  0.500)   [-0.26205739 -0.26205739  0.04337219  0.04337219] [ 1.08709135  1.08709135  1.44119276  1.44119276]
   4 ( 0.500  0.000  0.000)   [-0.41329452 -0.2483746   0.19386251  0.19386251] [ 1.16314613  1.16314613  1.16525103  1.56368119]
   5 ( 0.500  0.000  0.500)   [-0.26205739 -0.26205739  0.04337219  0.04337219] [ 1.08709135  1.08709135  1.44119276  1.44119276]
   6 ( 0.500  0.500  0.000)   [-0.26205739 -0.26205739  0.04337219  0.04337219] [ 1.08709135  1.08709135  1.44119276  1.44119276]
   7 ( 0.500  0.500  0.500)   [-0.41329452 -0.2483746   0.19386251  0.19386251] [ 1.16314613  1.16314613  1.16525103  1.56368119]
Ewald components = 1.35350024670892e-151, -1.08740537387457, 0.918918948338747
    CPU time for vj and vk    179.22 sec, wall time      2.95 sec
E1 = (4.00088387034+8.17569988321e-19j)  E_coul = (-2.26456180314+1.43268107183e-16j)
Ewald components = 2.62511131804051e-13, -33.8075273415067, 21.1383239417488
cycle= 5 E= -10.9328813325614  delta_E= -2.71e-10  |g|= 3.05e-06  |ddm|= 0.000147
    CPU time for cycle= 5    179.24 sec, wall time      2.98 sec
HOMO = 0.321224451529  LUMO = 0.9841990919
     k-point                  mo_energy
   0 ( 0.000  0.000  0.000)   [-0.66888868  0.32122445  0.32122445  0.32122445] [ 0.98419909  0.98419909  0.98419909  1.3482115 ]
   1 ( 0.000  0.000  0.500)   [-0.41328536 -0.24837112  0.19386477  0.19386477] [ 1.16314678  1.16314678  1.16524974  1.56367642]
   2 ( 0.000  0.500  0.000)   [-0.41328536 -0.24837112  0.19386477  0.19386477] [ 1.16314678  1.16314678  1.16524974  1.56367642]
   3 ( 0.000  0.500  0.500)   [-0.26204715 -0.26204715  0.04337451  0.04337451] [ 1.08708451  1.08708451  1.4411931   1.4411931 ]
   4 ( 0.500  0.000  0.000)   [-0.41328536 -0.24837112  0.19386477  0.19386477] [ 1.16314678  1.16314678  1.16524974  1.56367642]
   5 ( 0.500  0.000  0.500)   [-0.26204715 -0.26204715  0.04337451  0.04337451] [ 1.08708451  1.08708451  1.4411931   1.4411931 ]
   6 ( 0.500  0.500  0.000)   [-0.26204715 -0.26204715  0.04337451  0.04337451] [ 1.08708451  1.08708451  1.4411931   1.4411931 ]
   7 ( 0.500  0.500  0.500)   [-0.41328536 -0.24837112  0.19386477  0.19386477] [ 1.16314678  1.16314678  1.16524974  1.56367642]
Ewald components = 1.35350024670892e-151, -1.08740537387457, 0.918918948338747
    CPU time for vj and vk    229.79 sec, wall time      3.68 sec
E1 = (4.00088394817+8.17570287281e-19j)  E_coul = (-2.26456188097+1.44741514049e-16j)
Ewald components = 2.62511131804051e-13, -33.8075273415067, 21.1383239417488
Extra cycle  E= -10.932881332562  delta_E= -5.47e-13  |g|= 8.51e-07  |ddm|= 5.31e-06
    CPU time for scf_cycle   2027.15 sec, wall time     33.19 sec
    CPU time for SCF   2027.17 sec, wall time     33.21 sec
converged SCF energy = -10.932881332562
Ewald components = 1.35350024670892e-151, -1.08740537387457, 0.918918948338747
    CPU time for vj and vk    339.64 sec, wall time      6.22 sec
